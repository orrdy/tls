<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THAILAND LOCKSMITH 2024</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
    <link href="https://cdn.datatables.net/v/bs5/dt-2.1.8/b-3.1.2/date-1.5.4/fh-4.0.1/r-3.0.3/datatables.min.css"
        rel="stylesheet">
    <!-- icon -->
    <link rel="icon" href="https://img2.pic.in.th/pic/1730737040513.png" type="image/x-icon">
    <script
        src="https://cdn.datatables.net/v/bs5/dt-2.1.8/b-3.1.2/date-1.5.4/fh-4.0.1/r-3.0.3/datatables.min.js"></script>



    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: #e9e4bf;
        }

        .container {
            max-width: 400px;
        }

        .btn-orange {
            background-color: #f2a137;
            color: #000;
            border: none;
            font-size: 1.1rem;
            /* shadow */
            box-shadow: 0px 5px 0px rgba(192, 93, 16, 1);
            line-height: 3rem;
        }

        .btn-orange:hover {
            background-color: #c05d10;
            color: #fff;

        }

        .btn-gold {
            background-color: #fcc715;
            color: #000;
            border: none;
            font-size: 1.1rem;
            /* shadow */
            box-shadow: 0px 5px 0px rgba(247, 166, 20, 1);
            line-height: 3rem;
        }

        .btn-gold:hover {
            background-color: #f7a614;
            color: #fff;
        }

        .circle-orange-with-right-arrow {
            width: 50px;
            height: 50px;
            background-color: #c05d10;
            border-radius: 50%;
            position: relative;
            top: -54px;
            left: calc(100% - 35px);
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.8rem;

        }

        .circle-gold-with-right-arrow {
            width: 50px;
            height: 50px;
            background-color: #f7a614;
            border-radius: 50%;
            position: relative;
            top: -54px;
            left: calc(100% - 35px);
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.8rem;

        }

        .header-text {
            color: #555555
        }

        .form-control {
            background-color: #aababa;
            color: #000;
            border: none;
            border-radius: 15px
        }

        form label {
            font-size: 1.1rem !important;
            color: #4b4b49
        }


        .form-check-input {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .submit-btn {
            font-weight: bold;
            color: #333333;
            background: linear-gradient(to bottom, #64e27e, #36b258);
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            box-shadow: inset 3px 3px 5px rgba(255, 255, 255, 0.5),
                inset -3px -3px 5px rgba(0, 0, 0, 0.2),
                3px 3px 15px rgba(0, 0, 0, 0.3),
                0 0 10px rgba(100, 226, 126, 0.8);
            /* Stronger glow */
            text-align: center;
            line-height: 0.8rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .submit-btn:hover {
            transform: scale(1.05);
            box-shadow: inset 3px 3px 5px rgba(255, 255, 255, 0.5),
                inset -3px -3px 5px rgba(0, 0, 0, 0.2),
                3px 3px 15px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(100, 226, 126, 0.8),
                /* Enhanced glow on hover */
                0 0 30px rgba(100, 226, 126, 0.8);
        }

        .submit-btn:active {
            transform: scale(0.95);
        }

        table {
            tr {

                th,
                td {
                    vertical-align: middle;
                }
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid" id="scan-div">
        <div class="row justify-content-center m-1 rounded-3 d-none m-0 p-0" id="qrdiv">
            <div class="row justify-content-center m-0 p-0">
                <div class="col-md-6 m-0 p-0">
                    <div id="reader" class="img-fluid m-0 p-0"></div>
                </div>
            </div>
            <div class="row justify-content-center">
                <button class="btn btn-secondary fixed-top rounded-0" id="cancel-btn">ยกเลิก</button>
            </div>
        </div>
    </div>
    <div class="container-fluid" id="btn-div">
        <header class="container-fluid d-flex flex-column justify-content-center align-items-center mt-3">
            <img src="https://img2.pic.in.th/pic/1730737040513.png" alt="" style="width: 100px; max-height: 100px;"
                class="img-fluid mb-1">
            <div class="h3 lh-2 fw-bold w-100 header-text text-center">ADMIN<br>THAILAND LOCKSMITH 2024
            </div>
        </header>
        <main class="container-fluid">
            <section id="page1" class="pt-3 pages d-none">
                <div class="row">
                    <div class="col-12">
                        <div class="container">
                            <button class="btn btn-orange w-100 rounded-pill fw-bold lh-2 scan-card" disabled
                                id="scan-in-btn">
                                สแกนลูกค้าเข้างาน
                            </button>
                            <div class="circle-orange-with-right-arrow"><i class="bi bi-qr-code-scan"></i>
                            </div>
                        </div>

                    </div>
                    <!-- <div class="col-12">
                        <button class="btn btn-gold w-100 rounded-pill fw-bold lh-2" disabled id="show-customers-in">
                            แสดงลูกค้า
                            <span class="text-decoration-underline text-decoration-italic fst-italic text-danger">
                                เข้างานแล้ว
                            </span>
                        </button>
                        <div class="circle-gold-with-right-arrow"><i class="bi bi-table"></i>
                        </div>

                    </div> -->
                    <div class="col-12">
                        <div class="table-responsive">
                            <table id="customer-in-table" class="table table-striped table-bordered table-hover"
                                style="width: 100%">
                                <thead class="table-warning"></thead>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            <section>
                <!-- full screen modal with table for datatable -->
                <div class="modal fade" id="user-in" tabindex="-1" aria-labelledby="user-inLabel" aria-hidden="true">
                    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header" style="background-color: #f7a614;">
                                <h5 class="modal-title" id="user-inLabel">
                                    <img src="https://img2.pic.in.th/pic/1730737040513.png" alt=""
                                        style="width: 35px; max-height: 35px;" class="img-fluid">
                                    ลูกค้าเข้างานแล้ว</hjson>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">

                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                                <button type="button" class="btn btn-primary" id="user-in-refresh-btn">รีเฟรช</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <script>
        $(document).ready(function () {
            let page = new URLSearchParams(window.location.search).get('p');
            page = page == null ? 1 : page;
            if (page) {
                changePage(page);
            }
        });
        function changePage(page) {
            $('.pages').addClass('d-none');
            $('#page' + page).removeClass('d-none');
        }
    </script>
    <script>
        // var vConsole = new VConsole();
    </script>

    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbwCeN5KWWO6EjmK1QYeRodjef2qXNs01PeZS6xZQBzHH_3uFMxChgBavC4WAtH0wbwFHw/exec'
        const LIFF_ID = '1656187634-ZrAvz5Q9'
        var folder_token_obj, auth_users
        $(document).ready(() => {
            $.LoadingOverlay("show");
            liff.init({
                liffId: LIFF_ID,
                withLoginOnExternalBrowser: true
            })
            liff.ready.then(() => {
                // console.log(liff.getContext());
                // if (liff.getOS() != 'android' && liff.getContext().type != 'external') {
                //     liff.openWindow({ url: liff.getContext().endpointUrl, external: true })
                //     liff.closeWindow()
                // }
                initApp();

            });
        })

        $('#cancel-btn').on('click', function () {
            progress = ''
            html5QrCode.stop()
            $('#qrdiv').addClass('d-none')
            $('#btn-div').removeClass('d-none')
        })

        function initApp() {
            // $.post(scriptUrl, { opt: 'getAuth_users' }, function (res) {
            //     auth_users = res
            //     $.LoadingOverlay("hide");
            //     $('.scan-card').removeAttr('disabled')
            //     console.log("🚀 !! auth_users:", auth_users)
            // })
            // $.post(scriptUrl, { opt: 'getCustomers_in' }, function (res) { setCustomers_in_Table(res) })
            Promise.all([
                $.post(scriptUrl, { opt: 'getAuth_users' }, function (res) {
                    auth_users = res
                    $.LoadingOverlay("hide");
                    $('#scan-in-btn').removeAttr('disabled')
                    console.log("🚀 !! auth_users:", auth_users)
                }),
                $.post(scriptUrl, { opt: 'getCustomers_in' }, function (res) { setCustomers_in_Table(res) })
            ]).then(function (responses) {
                console.log('all done');
            }).catch(function (error) {
                console.error("Error fetching data:", error);
                $.LoadingOverlay("hide");
            });
            $('#scan-in-btn').click(() => {
                scancode()
            })
            $('#show-customers-in').click(() => {
                $('#user-in').modal('show')
            })

        }

        function setCustomers_in_Table(res) {
            console.log("🚀 !! res:", res)
            $.LoadingOverlay("hide");
            $('#show-customers-in').removeAttr('disabled')
            $('#user-in').off('shown.bs.modal').on('shown.bs.modal', function () {
                console.log('shown.bs.modal');
                setTimeout(() => {
                    $('#customer-in-table').DataTable().columns.adjust().responsive.recalc();
                    $('#customer-in-table').DataTable().draw();
                }, 100);
            })
            if (res.status != 'success' || res.data.length == 0) res.data = []
            let header = res.header
            $('#customer-in-table').DataTable({
                data: res.data,
                buttons: {
                    buttons: [
                        {
                            // refresh btn
                            text: '<i class="bi bi-arrow-clockwise"></i> Refresh',
                            className: 'btn btn-info rounded-pill',
                            action: function (e, dt, node, config) {
                                $.LoadingOverlay('show')
                                $.post(scriptUrl, { opt: 'getCustomers_in' }, function (res) {
                                    $.LoadingOverlay('hide')
                                    Object.keys(auth_users).forEach(id => {
                                        let index = res.data.findIndex(r => r['รหัสลูกค้า'] == id)
                                        if (index == -1) auth_users[id]['check-in'] = 'NO'
                                        else auth_users[id]['check-in'] = 'YES'
                                    })
                                    console.log("🚀 !! auth_users:", auth_users)
                                    setCustomers_in_Table(res)
                                })
                            }
                        }
                    ],
                    dom: {
                        button: {
                            className: 'btn btn-primary rounded-pill'
                        }
                    }
                },
                columns: [
                    {
                        title: header[0],
                        data: header[0],
                        render: function (data, type, row, meta) {
                            if (data == '') return ''
                            if (type === 'display') {
                                return moment(data).format('DD/MM/YYYY HH:mm:ss')
                            }
                            return new Date(data).getTime()
                        }

                    },
                    {
                        title: header[1],
                        data: header[1],
                        // custimer id
                        render: function (data, type, row, meta) {
                            if (data == '') return ''
                            if (data.indexOf('#') == 0) return `<span class="badge text-bg-warning" style="font-size: 1rem;">${data}</span>`
                            return `<span class="badge text-bg-primary" style="font-size: 1rem;">${data}</span>`

                        }
                    },
                    {
                        title: header[2],
                        data: header[2],
                    },
                    {
                        title: header[3],
                        data: header[3],
                    },
                    {
                        title: header[4],
                        data: header[4],
                        render: function (data, type, row, meta) {
                            if (data == '') return ''
                            if (data.toString().indexOf(',') > -1) data = data.toString().split(',')
                            else data = [data.toString()]
                            data = data.map(d => `<a href="tel:${d.replace(/-/g, '')}">${d.replace(/-/g, '')}</a>`).join('<br>')
                            return `<span><i class="bi bi-telephone-fill"></i> ${data}</span>`
                        }
                    },
                    {
                        title: header[5],
                        data: header[5],
                    },
                    {
                        title: header[6],
                        data: header[6],
                    },
                    {
                        title: header[7],
                        data: header[7],
                    },
                    {
                        title: header[8],
                        data: header[8],
                    },
                    {
                        title: header[9],
                        data: header[9],
                       
                    }
                ],
                "order": [[0, "desc"]],
                "language": {
                    "emptyTable": "ไม่มีข้อมูล",
                    "info": "แสดงข้อมูล _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                    "infoEmpty": "แสดงข้อมูล 0 ถึง 0 จาก 0 รายการ",
                    "infoFiltered": "(กรองข้อมูล _MAX_ รายการ)",
                    "lengthMenu": "แสดงข้อมูล _MENU_ รายการ",
                    "search": "ค้นหา:",
                    "zeroRecords": "ไม่พบข้อมูลที่ต้องการ",
                    "paginate": {
                        "first": "หน้าแรก",
                        "last": "หน้าสุดท้าย",
                        "next": "ถัดไป",
                        "previous": "ก่อนหน้า"
                    },
                },
                "pageLength": 10,
                "destroy": true,
                // "scrollX": true,
                // "scrollCollapse": true,
                "fixedHeader": true,
                "responsive": true,
                columnDefs: [
                    {
                        targets: '_all',
                        className: 'dt-head-center dt-head-nowrap'
                    },

                    {
                        targets: [1, 2, 5],
                        className: 'all dt-body-center',
                        responsivePriority: 1
                    },
                    {
                        targets: [9],
                        visible: false,
                    },
                    {
                        targets: [0, 1],
                        className: 'text-nowrap',
                    }
                ],
                "dom": '<"row justify-content-between"<"col-5 col-md-auto"B><"col-7 col-md-auto ml-auto search">>' +
                    '<"row mt-2"<"col-12"tr>>' +
                    '<"row justify-content-between mt-3 "<"col-6 col-md-auto"i><"col-6 col-md-auto"p>>',
                initComplete: function () {
                    $('.search').html('<input type="search" class="form-control" placeholder="ค้นหา...">')
                    $('.search input').on('keyup', function () {
                        $('#customer-in-table').DataTable().search(this.value).draw()
                    })
                }
            })

        }

        function scancode() {
            let os = liff.getOS()
            console.log("🚀 !! os:", os)
            if (os == 'web') {
                initSelfInput()
            } else if (os == 'ios') {
                initQrCode()
                // liff.scanCodeV2()
                //     .then((result) => {
                //         processData(result, type)
                //     })
            } else if (os == 'android') {
                liff.scanCodeV2()
                    .then((result) => {
                        processData(result)
                    })
            }
        }

        function processData(scan_text, callback = false) {
            console.log("🚀 !! scan_text:", scan_text)
            if ($('#qrdiv').is(':visible')) $('#qrdiv').addClass('d-none')
            if ($('#btn-div').is(':hidden')) $('#btn-div').removeClass('d-none')
            let id = scan_text.value.toUpperCase()
            if (id == null || id == '') return
            if (auth_users[id]) {
                if (!auth_users[id]['uid']) {
                    return Swal.fire({
                        icon: 'error',
                        title: 'ลูกค้ายังไม่ได้ลงทะเบียน',
                        confirmButtonText: 'รับทราบ',
                        allowOutsideClick: false,
                    }).then(() => {
                        scancode('checkin')
                    })
                }
                let table_data = $('#customer-in-table').DataTable().data().toArray()
                console.log("🚀 !! table_data:", table_data)
                if(table_data.length > 0){
                    let index = table_data.findIndex(r => r['รหัสลูกค้า'] == id)
                    if (index > -1) {
                        return Swal.fire({
                            icon: 'error',
                            title: 'ลูกค้าเข้างานซ้ำ',
                            confirmButtonText: 'รับทราบ',
                            allowOutsideClick: false,
                        }).then(() => {
                            scancode('checkin')
                        })
                    }
                }
                $.LoadingOverlay("show");
                $.post(scriptUrl, { opt: 'checkin', id: id, uid: liff.getDecodedIDToken().sub }, function (res) {
                    console.log("🚀 !! res:", res)
                    $.LoadingOverlay("hide");
                    if (res.status == 'success') {
                        $('#customer-in-table').DataTable().row.add(res.data).draw(false)
                        Swal.fire({
                            title: 'สแกนเข้างานสำเร็จ',
                            html: `<div class="container-fluid">
                                        <div class="row justify-content-center">
                                            <div class="col-12 text-center">
                                                <div class="h3 fw-bold mt-2">${auth_users[id].name}</div>
                                            </div>
                                            <div class="col-12 text-center">
                                                <div class="fw-bold">${auth_users[id].province}</div>
                                            </div>
                                        </div>
                                    </div>`,
                            allowOutsideClick: false,
                            showCancelButton: true,
                            confirmButtonText: 'รับทราบ',
                            cancelButtonText: liff.getOS() == 'web' ? 'ปิด' : 'ปิดกล้อง',
                            confirmButtonColor: '#7ed957',
                            cancelButtonColor: '#d33',
                            reverseButtons: true,
                            timer: 1000 * 60 * 20
                        }).then((result) => {
                            auth_users[id]['check-in'] = 'Yes'
                            if (result.isConfirmed) {
                                scancode()
                            }
                        })

                    } else if (res.status == 'already checked') {
                        return Swal.fire({
                            icon: 'error',
                            title: 'ลูกค้าเข้างานซ้ำ',
                            confirmButtonText: 'รับทราบ',
                            showCancelButton: true,
                            cancelButtonText: liff.getOS() == 'web' ? 'ปิด' : 'ปิดกล้อง',
                            allowOutsideClick: false,
                            reverseButtons: true
                        })
                    } else if (res.status == 'no auth') {
                        Swal.fire({
                            icon: 'error',
                            title: 'ยังไม่ได้สิทธิ์เข้างาน',
                            html: `ลูกค้ารหัส <span class="text-danger fw-bold">${id}</span> ยังไม่ได้สิทธิ์ลงเข้างาน`,
                            confirmButtonText: 'รับทราบ',
                            showCancelButton: true,
                            cancelButtonText: liff.getOS() == 'web' ? 'ปิด' : 'ปิดกล้อง',
                            allowOutsideClick: false,
                            reverseButtons: true
                        }).then(() => {
                            scancode('checkin')
                        })
                    }
                })


            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'ลูกค้าไม่มีสิทธิ์ลงทะเบียนเข้างาน',
                    html: 'กรุณาติดต่อแอดมิน <br><a href="tel:0891109020">089-110-9020</a> <br><a href="tel:028681990">02-868-1990</a>',
                    confirmButtonText: 'รับทราบ',
                    showCancelButton: true,
                    cancelButtonText: liff.getOS() == 'web' ? 'ปิด' : 'ปิดกล้อง',
                    reverseButtons: true,
                    allowOutsideClick: false,
                }).then(() => {
                    scancode('checkin')
                })
            }
        }

    </script>

    <script>
        const config = { fps: 30, aspectRatio: 1.777778 };
        // This method will trigger user permissions
        var html5QrCode
        function initQrCode(type) {
            html5QrCode = new Html5Qrcode("reader");
            const qrCodeSuccessCallback = message => {
                html5QrCode.stop().then(ignore => {
                    console.log("🚀 ~ message", message)
                    return processData({ value: message }, type)
                }).catch(err => {
                    // Stop failed, handle it.
                });
            }
            $('#qrdiv').removeClass('d-none')
            $('#btn-div').addClass('d-none')
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
        }

        function initSelfInput() {
            Swal.fire({
                title: 'ลงทะเบียนเข้างาน',
                text: 'กรุณากรอกรหัสลูกค้า',
                input: 'text',
                inputAttributes: {
                    autocapitalize: 'off'
                },
                customClass: {
                    input: 'rounded bg-primary-subtle text-dark text-center'
                },
                showCancelButton: true,
                confirmButtonText: 'ตกลง',
                cancelButtonText: 'ยกเลิก',
                showLoaderOnConfirm: true,
                allowOutsideClick: false,
                autoFocus: true,
                preConfirm: (id) => {
                    return id.toUpperCase()
                },
                inputValidator: (id) => {
                    if (!id) {
                        return 'กรุณากรอกรหัสลูกค้า'
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    processData({ value: result.value })
                }
            })
        }
    </script>
    <script>
        // form validation
        (() => {
            'use strict'

            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            const forms = document.querySelectorAll('.needs-validation')

            // Loop over them and prevent submission
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    event.preventDefault()
                    if (!form.checkValidity()) {
                        event.stopPropagation()
                        form.classList.add('was-validated')
                        $(form).find(":invalid").first().focus();
                    } else {
                        if ($(form).attr('id') == 'authen-form') {
                            userValidate();
                        } else if ($(form).attr('id') == 'register-form') {
                            userRegister();
                        }
                    }

                })
            })
        })()
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <!-- vconsole -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vConsole/3.9.1/vconsole.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.0.1/html5-qrcode.min.js"
        integrity="sha512-JXdlXFkKGAhP2yUubNT7hXNjEtPrAJz1Gs7oztdP47KhqL5ux88uof5FnIm2D0Ud/TdqiAe1mM1179kJDy/HKA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
</body>

</html>
